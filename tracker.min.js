import platform from"platform";const isBrowser="undefined"!=typeof window,validate=function(t={}){const e={};return e.detailed=!0===t.detailed,e.ignoreLocalhost=!1!==t.ignoreLocalhost,e.ignoreOwnVisits=!1!==t.ignoreOwnVisits,e},isLocalhost=function(t){return""===t||"localhost"===t||"127.0.0.1"===t||"::1"===t},isBot=function(t){return/bot|crawler|spider|crawling/i.test(t)},isFakeId=function(t){return"88888888-8888-8888-8888-888888888888"===t},isInBackground=function(){return"hidden"===document.visibilityState},source=function(){const t=(location.search.split("source=")[1]||"").split("&")[0];return""===t?void 0:t};export const attributes=function(t=!0){const e={siteLocation:window.location.href,siteReferrer:document.referrer,source:source()},n={siteLanguage:(navigator.language||navigator.userLanguage).substr(0,2),screenWidth:screen.width,screenHeight:screen.height,screenColorDepth:screen.colorDepth,deviceName:platform.product,deviceManufacturer:platform.manufacturer,osName:platform.os.family,osVersion:platform.os.version,browserName:platform.name,browserVersion:platform.version,browserWidth:window.outerWidth,browserHeight:window.outerHeight};return{...e,...!0===t?n:{}}};const createRecordBody=function(t,e){return{query:"\n\t\t\tmutation createRecord($domainId: ID!, $input: CreateRecordInput!) {\n\t\t\t\tcreateRecord(domainId: $domainId, input: $input) {\n\t\t\t\t\tpayload {\n\t\t\t\t\t\tid\n\t\t\t\t\t\textraData\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t",variables:{domainId:t,input:e}}},updateRecordBody=function(t){return{query:"\n\t\t\tmutation updateRecord($recordId: ID!) {\n\t\t\t\tupdateRecord(id: $recordId) {\n\t\t\t\t\tsuccess\n\t\t\t\t}\n\t\t\t}\n\t\t",variables:{recordId:t}}},createActionBody=function(t,e){return{query:"\n\t\t\tmutation createAction($eventId: ID!, $input: CreateActionInput!) {\n\t\t\t\tcreateAction(eventId: $eventId, input: $input) {\n\t\t\t\t\tpayload {\n\t\t\t\t\t\tid\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t",variables:{eventId:t,input:e}}},updateActionBody=function(t,e){return{query:"\n\t\t\tmutation updateAction($actionId: ID!, $input: UpdateActionInput!) {\n\t\t\t\tupdateAction(id: $actionId, input: $input) {\n\t\t\t\t\tsuccess\n\t\t\t\t}\n\t\t\t}\n\t\t",variables:{actionId:t,input:e}}},endpoint=function(t){const e="/"===t.substr(-1);return t+(!0===e?"":"/")+"api"},send=function(t,e,n,o){const r=new XMLHttpRequest;r.open("POST",t),r.onload=()=>{if(200!==r.status)throw console.log(r),console.log(r.errors),new Error("Server returned with an unhandled status");let t=null;try{t=JSON.parse(r.responseText)}catch(t){throw new Error("Failed to parse response from server")}if(null!=t.errors)throw new Error(t.errors[0].message);if("function"==typeof o)return o(t)},r.setRequestHeader("Content-Type","application/json;charset=UTF-8"),r.withCredentials=n.ignoreOwnVisits,console.log(JSON.stringify(e)),r.send(JSON.stringify(e))};export const detect=function(){const t=document.querySelector("[data-ackee-domain-id]");if(null==t)return;const e=t.getAttribute("data-ackee-server")||"",n=t.getAttribute("data-ackee-domain-id"),o=t.getAttribute("data-ackee-opts")||"{}";create(e,JSON.parse(o)).record(n)};export const create=function(t,e){e=validate(e);const n=endpoint(t),o=()=>{},r={record:()=>({stop:o}),updateRecord:()=>({stop:o}),action:o,updateAction:o};if(!0===e.ignoreLocalhost&&!0==(""===(i=location.hostname)||"localhost"===i||"127.0.0.1"===i||"::1"===i))return console.warn("Ackee ignores you because you are on localhost"),r;var i,a;if(!0===(a=navigator.userAgent,/bot|crawler|spider|crawling/i.test(a)))return console.warn("Ackee ignores you because you are a bot"),r;return{record:(t,o=attributes(e.detailed),r)=>{let i=!1;return send(n,createRecordBody(t,o),e,(t=>{const e=t.data.createRecord.payload.id;return!0===isFakeId(e)?console.warn("Ackee ignores you because this is your own site"):"function"==typeof r?r(e):void 0})),{stop:()=>{i=!0}}},updateRecord:t=>{let o=!1;const r=()=>{o=!0};if(!0===isFakeId(t))return console.warn("Ackee ignores you because this is your own site"),{stop:r};const i=setInterval((()=>{!0!==o?"hidden"===document.visibilityState!=!0&&send(n,updateRecordBody(t),e):clearInterval(i)}),15e3);return{stop:r}},action:(t,o,r)=>{send(n,createActionBody(t,o),e,(t=>{const e=t.data.createAction.payload.id;return!0===isFakeId(e)?console.warn("Ackee ignores you because this is your own site"):"function"==typeof r?r(e):void 0}))},updateAction:(t,o)=>{if(!0===isFakeId(t))return console.warn("Ackee ignores you because this is your own site");send(n,updateActionBody(t,o),e)}}};!0===isBrowser&&detect();
